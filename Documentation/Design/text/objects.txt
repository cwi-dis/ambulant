Ambulant design, main objects 
=============================

Objects we have:

- `Event processor`_. This is the mainloop plus the event/callback mechanism.
- `Data source`_. Think of these as "media items", they may refer to a URL
  or part of a multiplexed stream or so, and provide data to renderers and
  to the parser.
- `Region`_. This is an area of screen space (or a speaker). It is "what
  the user sees".
- `Renderer`_. These decode data streams, handle timing and do bitblitting
  or push audio through.
- `Clocks`_. These advance a virtual time.
- `Document`_. The representation of a SMIL document.
- `Document parser`_. The parser for a document.
- `Timeline`_. This executes a single timeline.
- `Player`_. This is the toplevel object.

.. _Event processor: event_processor.html
.. _Data source: datasource.html
.. _Region: region.html
.. _Renderer: renderer.html
.. _Document: document.html
.. _Timeline: timeline.html
.. _Player: player.html

For each of these we have an accompanying PDF document with UML graphics
showing how the object relates to other objects. These can be found
in the `models`_ directory.

.. _models: ../models

  
In addition we have various auxiliary objects that are explained in
`auxobjects.txt`_.

.. _auxobjects.txt: auxobjects.html

Common protocols
----------------

There are a number of (formal and informal) protocols that are shared among
multiple object classes: the `refcounting protocol` and the `active/passive
protocol`.

The `refcounting protocol` is contained in the file ``lib/refcount.h``. It needs to
be implemented only by objects that are truly shared, i.e. any object whose
lifetime is not predetermined by some other object. New instances of refcounted
objects are created using the operator new. Any object that needs to share
a particular instance calls add_ref against this instance. The creator
of the refcounted object and any sharer are responsible to call the release
function of the object when they don't need the object any more. 

The `active/passive protocol` is more a pattern than a protocol. The pattern
is used often in Ambulant for objects that go through two stages during
their lifetime: a building stage and an active (running) stage. The passive
object is the object that corresponds to the building stage and the built
stage that follows it. The passive object *appears* to be immutable.
Once the object actually needs to do work we activate it, giving a new instance
of an active object that does the actual work. The passive object remains
in existence, and can be re-used.

Note that I say "appears immutable": passive objects could internally cache
information, or keep one or more active instances ready for quick disposal.

Clocks
------

*NOTE*: in the current implementation clocks do not yet exist, and
there is only the global realtime clock. The interface is in ``lib/timer.h`` and
``lib/delta_timer.h``.

Clocks come in two flavors. The normal flavor is a free-running clock, a
renderer that is subscribed to it can access it in two modes (depending
on what programming model it prefers): callback or polling. In callback
mode it will get callbacks when the virtual clock time has drifted more
than delta from the wallclock. In polling mode it can ask for the time
and ask for a callback at a specific time/interval. Renderers can also
tell the clock what time they think it is, but this is completely
ignored.

The other clock flavor is the master clock. Each normal clock can have
at most one master clock attached to it. The master clock has the same
API as a normal clock, from the renderer point of view, but it does not
give callbacks and it *does* listen when the renderer tells it what time
it is (and updates its dependent slave clock). The scheduler assigns a
master clock for the SMIL syncMaster attribute.

	*NOTE* I am rethinking this section. The fact that some times a clock
	is slaved to another clock and sometimes it is slaved to a renderer needs
	to be exploited, probably through an interface for any object that can
	be master to a clock. Then all clocks will be slaved to such a clock
	master, either another clock, a renderer or the "realtime master clock"
	object.

Document parser
---------------

To be supplied by KK. Interface is in (I guess) ``lib/expat_parser.h``,
``lib/nscontext.h`` (correct?), ``lib/parse_attrs.h``, ``lib/region_eval.h``,
``lib/sax_handler.h``, ``lib/sax_types.h`` (correct?), ``lib/smil_handler.h``.

